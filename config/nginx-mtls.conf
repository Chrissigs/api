# NGINX mTLS Configuration for Project Passport
# Workstream B.1: Mutual TLS Enforcement
#
# This configuration enforces client certificate validation at the infrastructure layer,
# preventing untrusted banks from accessing the API even if they have valid credentials.
#
# Deployment: Place in /etc/nginx/sites-available/ and symlink to sites-enabled/

upstream project_passport_api {
    server 127.0.0.1:3000;
    keepalive 32;
}

server {
    listen 443 ssl;
    server_name api.projectpassport.example.com;

    # Server TLS Configuration
    ssl_certificate /etc/nginx/ssl/server-cert.pem;
    ssl_certificate_key /etc/nginx/ssl/server-key.pem;
    
    # TLS 1.3 enforcement (highest security)
    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;
    
    # CRITICAL: Mutual TLS Client Certificate Validation
    # This is the core security control - reject connections without valid client cert
    ssl_verify_client on;
    ssl_client_certificate /etc/nginx/ssl/ca-cert.pem;
    ssl_verify_depth 2;
    
    # Optional: CRL (Certificate Revocation List) checking
    # ssl_crl /etc/nginx/ssl/ca-crl.pem;
    
    # Session timeout
    ssl_session_timeout 10m;
    ssl_session_cache shared:SSL:10m;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging (capture mTLS events)
    access_log /var/log/nginx/project_passport_access.log combined;
    error_log /var/log/nginx/project_passport_error.log warn;

    location / {
        # Pass client certificate fingerprint to application layer
        # This allows the app to bind the cert identity to JWT issuer
        proxy_set_header X-Client-Cert-Fingerprint $ssl_client_fingerprint;
        proxy_set_header X-Client-Cert-Serial $ssl_client_serial;
        proxy_set_header X-Client-Cert-Subject-DN $ssl_client_s_dn;
        
        # Standard reverse proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # HTTP/1.1 support
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        proxy_pass http://project_passport_api;
    }

    # Health check endpoint (no mTLS required for internal monitoring)
    location /health {
        ssl_verify_client off;
        proxy_pass http://project_passport_api/health;
    }
}

# HTTP -> HTTPS redirect
server {
    listen 80;
    server_name api.projectpassport.example.com;
    
    location / {
        return 301 https://$host$request_uri;
    }
}
